<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cronkite — Student Inbox</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --paper: #f5f0e8;
      --paper-dark: #ede8dc;
      --paper-darker: #dbd2be;
      --ink: #0a0a0a;
      --ink-mid: #4a3f2f;
      --ink-light: #7d6e56;
      --red: #c8102e;
      --red-dark: #a50d26;
      --border: #c5b89a;
      --green: #2d6a4f;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--paper);
      color: var(--ink);
      min-height: 100vh;
    }

    /* ── Auth Screen ── */
    #auth-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }

    .auth-card {
      background: var(--paper-dark);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 48px 40px;
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .auth-card h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 28px;
      color: var(--ink);
      margin-bottom: 6px;
    }

    .auth-card .tagline {
      font-size: 11px;
      color: var(--red);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 32px;
    }

    .auth-card p {
      font-size: 13px;
      color: var(--ink-mid);
      line-height: 1.6;
      margin-bottom: 28px;
    }

    /* ── Header ── */
    #app-screen { display: none; }

    .site-header {
      background: var(--ink);
      border-bottom: 2px solid var(--red);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-brand {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .header-brand h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 18px;
      color: var(--paper);
    }

    .header-brand span {
      font-size: 10px;
      color: var(--red);
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-user-name {
      font-size: 13px;
      color: var(--paper-darker);
    }

    /* ── Buttons ── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 18px;
      border-radius: 7px;
      font-size: 13px;
      font-weight: 600;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: all 0.18s;
      border: none;
    }

    .btn-primary { background: var(--red); color: var(--paper); }
    .btn-primary:hover { background: var(--red-dark); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn-outline {
      background: transparent;
      color: var(--ink-mid);
      border: 1px solid var(--border);
    }
    .btn-outline:hover { border-color: var(--ink); color: var(--ink); }

    .btn-google {
      background: var(--paper);
      color: var(--ink);
      border: 1px solid var(--border);
      padding: 12px 24px;
      font-size: 14px;
      border-radius: 8px;
      width: 100%;
      justify-content: center;
    }
    .btn-google:hover { border-color: var(--ink); transform: translateY(-1px); }

    .btn-signout {
      background: transparent;
      color: var(--paper-darker);
      border: 1px solid #3a3a3a;
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 6px;
    }
    .btn-signout:hover { border-color: var(--paper-darker); color: var(--paper); }

    .btn-done {
      background: var(--green);
      color: #fff;
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: default;
      opacity: 0.85;
    }

    .btn-sm { padding: 6px 14px; font-size: 12px; }

    /* ── Layout ── */
    .page-wrap {
      max-width: 760px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 22px;
      color: var(--ink);
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--ink-light);
      letter-spacing: 0.5px;
      margin-bottom: 28px;
    }

    /* ── Module Group ── */
    .module-group {
      margin-bottom: 28px;
    }

    .module-group-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .module-group-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 17px;
      color: var(--ink);
      flex: 1;
    }

    .focus-badge {
      background: var(--paper-dark);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 10px;
      font-weight: 600;
      color: var(--ink-mid);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      flex-shrink: 0;
    }

    .module-desc-small {
      font-size: 12px;
      color: var(--ink-light);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    /* ── Assignment Cards ── */
    .assignment-card {
      background: var(--paper-dark);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 18px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }

    .assignment-card.completed {
      opacity: 0.7;
      border-color: rgba(197,184,154,0.5);
    }

    .assignment-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
      margin-top: 4px;
      border: 2px solid var(--border);
    }

    .assignment-card.completed .assignment-status-dot {
      background: var(--green);
      border-color: var(--green);
    }

    .assignment-body { flex: 1; min-width: 0; }

    .assignment-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .assignment-url-preview {
      font-size: 11px;
      color: var(--ink-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 10px;
    }

    .assignment-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .completed-label {
      font-size: 11px;
      color: var(--green);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .completed-date {
      font-size: 11px;
      color: var(--ink-light);
    }

    .score-chip {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }

    .score-green { background: #dcfce7; color: #166534; }
    .score-amber { background: #fef3c7; color: #92400e; }
    .score-red   { background: #fee2e2; color: #991b1b; }

    /* ── Spinner / Toast ── */
    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--ink);
      color: var(--paper);
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.25s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: var(--red); }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--ink-light);
    }

    .empty-state h3 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 18px;
      color: var(--ink);
      margin-bottom: 8px;
    }

    .empty-state p { font-size: 13px; line-height: 1.6; }

    .rls-notice {
      background: #fffbeb;
      border: 1px solid #f6d28a;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      color: #92400e;
      line-height: 1.6;
      margin-bottom: 20px;
      display: none;
    }

    @media (max-width: 600px) {
      .site-header { padding: 0 16px; }
      .page-wrap { padding: 20px 16px; }
      .assignment-card { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>

  <!-- Auth Screen -->
  <div id="auth-screen">
    <div class="auth-card">
      <h1>Cronkite</h1>
      <div class="tagline">Student Inbox</div>
      <p>View articles assigned by your teacher and analyse them with Cronkite's AI fact-checker.</p>
      <button class="btn btn-google" id="google-login-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="flex-shrink:0">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <!-- App Screen -->
  <div id="app-screen">
    <header class="site-header">
      <div class="header-brand">
        <h1>Cronkite</h1>
        <span>Student Inbox</span>
      </div>
      <div class="header-user">
        <span class="header-user-name" id="user-name-display"></span>
        <button class="btn btn-signout" id="signout-btn">Sign out</button>
      </div>
    </header>

    <div class="page-wrap">
      <h2 class="page-title">Your Assignments</h2>
      <p class="page-subtitle">Articles assigned by your teacher. Click "Analyse" to fact-check with Cronkite.</p>

      <!--
        NOTE FOR ADMINS: If students see no assignments, add these RLS policies in
        Supabase SQL Editor so students can read all modules/assignments:

        CREATE POLICY "modules: all authenticated read" ON public.modules
          FOR SELECT TO authenticated USING (true);

        CREATE POLICY "assignments: all authenticated read" ON public.assignments
          FOR SELECT TO authenticated USING (true);
      -->
      <div class="rls-notice" id="rls-notice">
        No assignments visible. If you're the admin, add permissive read policies for <strong>modules</strong> and <strong>assignments</strong> in the Supabase SQL Editor — see the HTML comment above this notice.
      </div>

      <div id="inbox-container">
        <div style="padding:24px;color:var(--ink-light);font-size:13px"><span class="spinner"></span>Loading your inbox…</div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ── Supabase init ──
    // Get your anon key from: Supabase Dashboard → Project Settings → API → anon/public
    const SUPABASE_URL = 'https://givyodepnqelhhmtmypk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpdnlvZGVwbnFlbGhobXRteXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMzIxODIsImV4cCI6MjA4NzcwODE4Mn0.xqUQLEKfsIs2lxncsYJk7CwkXWat4QCL3xF78ixgnpk';

    // URL of the Cronkite web app for analysis
    const CRONKITE_EDU_URL = 'https://cronkite-backend-production.up.railway.app/app';

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ── Toast ──
    function toast(msg, type = 'ok') {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast show' + (type === 'error' ? ' error' : '');
      clearTimeout(el._timer);
      el._timer = setTimeout(() => { el.className = 'toast'; }, 3200);
    }

    // ── Auth ──
    let currentUser = null;

    document.getElementById('google-login-btn').addEventListener('click', async () => {
      const { error } = await sb.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: 'https://cronkite-backend-production.up.railway.app/student' }
      });
      if (error) toast('Login error: ' + error.message, 'error');
    });

    document.getElementById('signout-btn').addEventListener('click', async () => {
      await sb.auth.signOut();
      location.reload();
    });

    sb.auth.onAuthStateChange(async (event, session) => {
      if (session?.user) {
        currentUser = session.user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        const name = session.user.user_metadata?.full_name || session.user.email;
        document.getElementById('user-name-display').textContent = name;
        await loadInbox();
      } else {
        currentUser = null;
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('app-screen').style.display = 'none';
      }
    });

    // ── Inbox ──
    async function loadInbox() {
      const container = document.getElementById('inbox-container');

      // Fetch all modules (requires permissive RLS)
      const { data: modules, error: mErr } = await sb
        .from('modules')
        .select('id, title, description, focus_point')
        .order('created_at', { ascending: true });

      if (mErr) {
        container.innerHTML = `<div class="empty-state"><h3>Could not load modules</h3><p>${escapeHtml(mErr.message)}</p></div>`;
        return;
      }

      if (!modules || modules.length === 0) {
        document.getElementById('rls-notice').style.display = 'block';
        container.innerHTML = '';
        return;
      }

      // Fetch all assignments
      const { data: assignments, error: aErr } = await sb
        .from('assignments')
        .select('id, module_id, article_title, article_url')
        .order('created_at', { ascending: true });

      if (aErr) {
        container.innerHTML = `<div class="empty-state"><h3>Could not load assignments</h3><p>${escapeHtml(aErr.message)}</p></div>`;
        return;
      }

      // Fetch student's own results
      const { data: myResults } = await sb
        .from('student_results')
        .select('assignment_id, analysis_json, completed_at')
        .eq('student_id', currentUser.id);

      const resultMap = {};
      (myResults || []).forEach(r => { resultMap[r.assignment_id] = r; });

      // Group assignments by module
      const assignmentsByModule = {};
      (assignments || []).forEach(a => {
        if (!assignmentsByModule[a.module_id]) assignmentsByModule[a.module_id] = [];
        assignmentsByModule[a.module_id].push(a);
      });

      container.innerHTML = '';

      let anyAssignments = false;

      modules.forEach(mod => {
        const modAssignments = assignmentsByModule[mod.id] || [];
        if (modAssignments.length === 0) return;

        anyAssignments = true;

        const group = document.createElement('div');
        group.className = 'module-group';

        group.innerHTML = `
          <div class="module-group-header">
            <div class="module-group-title">${escapeHtml(mod.title)}</div>
            ${mod.focus_point ? `<span class="focus-badge">${escapeHtml(mod.focus_point)}</span>` : ''}
          </div>
          ${mod.description ? `<div class="module-desc-small">${escapeHtml(mod.description)}</div>` : ''}
        `;

        modAssignments.forEach(a => {
          const result = resultMap[a.id];
          const isDone = !!result;
          const card = buildAssignmentCard(a, result, isDone);
          group.appendChild(card);
        });

        container.appendChild(group);
      });

      if (!anyAssignments) {
        container.innerHTML = '<div class="empty-state"><h3>No assignments yet</h3><p>Your teacher hasn\'t assigned any articles yet. Check back soon.</p></div>';
      }
    }

    function buildAssignmentCard(assignment, result, isDone) {
      const card = document.createElement('div');
      card.className = 'assignment-card' + (isDone ? ' completed' : '');
      card.id = `card-${assignment.id}`;

      const score = result?.analysis_json?.overall_score;
      const scoreClass = typeof score === 'number'
        ? (score >= 70 ? 'score-green' : score >= 40 ? 'score-amber' : 'score-red')
        : '';

      const completedDate = result?.completed_at
        ? new Date(result.completed_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
        : null;

      let actionsHtml;
      if (isDone) {
        actionsHtml = `
          <span class="completed-label">✓ Completed</span>
          ${completedDate ? `<span class="completed-date">${completedDate}</span>` : ''}
          ${typeof score === 'number' ? `<span class="score-chip ${scoreClass}">${score} / 100</span>` : ''}
          <a class="btn btn-outline btn-sm" href="${escapeHtml(assignment.article_url)}" target="_blank" rel="noopener">Open Article</a>
        `;
      } else {
        actionsHtml = `
          <a class="btn btn-primary btn-sm" href="${buildAnalyseUrl(assignment.article_url)}" target="_blank" rel="noopener">Analyse with Cronkite</a>
          <button class="btn btn-outline btn-sm" onclick="markComplete('${assignment.id}')">Mark Complete</button>
        `;
      }

      card.innerHTML = `
        <div class="assignment-status-dot"></div>
        <div class="assignment-body">
          <div class="assignment-title">${escapeHtml(assignment.article_title || assignment.article_url)}</div>
          <div class="assignment-url-preview">${escapeHtml(assignment.article_url)}</div>
          <div class="assignment-actions">${actionsHtml}</div>
        </div>
      `;

      return card;
    }

    function buildAnalyseUrl(articleUrl) {
      // Opens cronkite-edu.html with the article URL pre-filled (if supported)
      return `${CRONKITE_EDU_URL}?url=${encodeURIComponent(articleUrl)}`;
    }

    async function markComplete(assignmentId) {
      const btn = document.querySelector(`#card-${assignmentId} .btn-outline`);
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Saving…'; }

      // Upsert with empty analysis (student completed without full AI result)
      const { error } = await sb.from('student_results').upsert({
        student_id: currentUser.id,
        assignment_id: assignmentId,
        analysis_json: {},
        completed_at: new Date().toISOString()
      }, { onConflict: 'student_id,assignment_id' });

      if (error) {
        toast('Error saving: ' + error.message, 'error');
        if (btn) { btn.disabled = false; btn.textContent = 'Mark Complete'; }
        return;
      }

      toast('Marked as complete!');
      await loadInbox();
    }

    // ── Utils ──
    function escapeHtml(text) {
      const d = document.createElement('div');
      d.appendChild(document.createTextNode(String(text)));
      return d.innerHTML;
    }
  </script>
</body>
</html>
